<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relic√°rio DeusOt ‚Äî N√≠veis e Custos</title>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #121a27;
      --panel2: #0f1622;
      --text: #e9eef7;
      --muted: #a8b3c7;
      --stroke: rgba(255,255,255,.08);
      --stroke2: rgba(255,255,255,.14);
      --accent: #7c5cff;
      --accent2: #2be4c6;
      --radius: 16px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(43,228,198,.22), transparent 60%),
        var(--bg);
    }

    /* Topbar */
    header.topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px 16px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(11, 15, 23, 0.78);
      backdrop-filter: blur(10px);
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 44px; height: 44px;
      border-radius: 14px;
      display: grid; place-items: center;
      font-weight: 900;
      background: linear-gradient(145deg, rgba(124,92,255,.95), rgba(43,228,198,.55));
      box-shadow: var(--shadow);
    }
    .brand-text h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .brand-text p { margin: 2px 0 0; color: var(--muted); font-size: 13px; }

    .tools { display: flex; align-items: center; gap: 10px; }
    .tools input {
      width: min(420px, 55vw);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(18, 26, 39, 0.72);
      color: var(--text);
      outline: none;
    }
    .tools input::placeholder { color: rgba(168,179,199,.7); }
    .tools button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(18, 26, 39, 0.72);
      color: var(--text);
      cursor: pointer;
      transition: border-color .12s ease, transform .12s ease;
    }
    .tools button:hover { border-color: var(--stroke2); transform: translateY(-1px); }

    /* ====== LAYOUT (custos em cima, grid abaixo) ====== */
    main.layout {
      padding: 16px;
      display: grid;
      gap: 16px;
    }

    .row-grid {
      display: grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .row-grid { grid-template-columns: 1fr; }
      .tools input { width: 58vw; }
    }

    .panel {
      background: rgba(18, 26, 39, 0.66);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Costs card */
    .costs {
      padding: 14px;
      background: rgba(15, 22, 34, 0.58);
    }
    .costs h2 {
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .4px;
      text-transform: uppercase;
    }
    .costs p {
      margin: 0 0 10px;
      color: rgba(233,238,247,.92);
      line-height: 1.45;
      font-size: 13.5px;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(11, 15, 23, 0.5);
      color: var(--text);
      font-size: 12.5px;
      font-variant-numeric: tabular-nums;
    }
    .chip b { color: rgba(233,238,247,.95); }
    .chip .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      background: rgba(18, 26, 39, 0.5);
      font-size: 11px;
    }

    /* Left: levels card */
    .levels-wrap { padding: 14px; }
    .levels-wrap h3 {
      margin: 6px 4px 12px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .4px;
      text-transform: uppercase;
    }

    .grid-levels {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 560px) {
      .grid-levels { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .card {
      position: relative;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15, 22, 34, 0.95), rgba(18, 26, 39, 0.6));
      cursor: pointer;
      user-select: none;
      transition: transform 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
      min-height: 88px;
    }
    .card:hover { transform: translateY(-2px); border-color: var(--stroke2); }
    .card.active {
      border-color: rgba(124, 92, 255, 0.65);
      box-shadow: 0 0 0 3px rgba(124, 92, 255, 0.18);
    }
    .card .lvl { font-weight: 900; font-size: 14px; }
    .card .sub { margin-top: 6px; color: var(--muted); font-size: 12px; }
    .badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(11, 15, 23, 0.55);
      color: var(--muted);
    }

    /* "aqui" widget */
    .here {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid rgba(43, 228, 198, 0.4);
      background: rgba(43, 228, 198, 0.12);
      color: rgba(233,238,247,.95);
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      width: fit-content;
    }
    .here::before{
      content:"‚Ä¢";
      color: var(--accent2);
      margin-right: 8px;
      font-size: 14px;
      line-height: 0;
    }

    /* Right: details card */
    .details-header {
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(15, 22, 34, 0.68);
    }
    .details-header h3 { margin: 0; font-size: 16px; }
    .meta { display: inline-block; margin-top: 6px; color: var(--muted); font-size: 12px; }

    .details-body { padding: 14px; }
    .hint {
      border: 1px dashed var(--stroke);
      border-radius: 14px;
      padding: 14px;
      color: var(--muted);
      background: rgba(15, 22, 34, 0.35);
      line-height: 1.5;
      font-size: 13px;
    }

    .items { display: grid; gap: 10px; margin-top: 10px; }
    .item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px 12px;
      padding: 12px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(15, 22, 34, 0.5);
      align-items: center;
    }
    .item .name { font-weight: 650; }

    /* qty pill */
    .item .qty {
      font-variant-numeric: tabular-nums;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(11, 15, 23, 0.45);
      justify-self: end;
      white-space: nowrap;
    }

    .item .subline {
      grid-column: 1 / -1;
      color: rgba(168,179,199,.9);
      font-size: 12px;
      line-height: 1.35;
    }
    .item .subline b { color: rgba(233,238,247,.95); }

    /* ================================
       DROPPED BY (NOVO)
       ================================ */
    .drops {
      grid-column: 1 / -1;
      display: grid;
      gap: 8px;
      margin-top: 2px;
    }
    .drops .drops-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: rgba(233,238,247,.92);
      font-size: 12px;
    }
    .drops .drops-head b { color: rgba(233,238,247,.95); }
    .drops .drops-head .count {
      font-variant-numeric: tabular-nums;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(11, 15, 23, 0.35);
      color: var(--muted);
      font-size: 11px;
      white-space: nowrap;
    }
    .drops .chipsWrap {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .dropchip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(11, 15, 23, 0.45);
      color: rgba(233,238,247,.92);
      font-size: 12px;
      line-height: 1;
      max-width: 100%;
    }
    .dropchip::before{
      content:"‚ú¶";
      color: rgba(43,228,198,.9);
      font-size: 12px;
      transform: translateY(-0.5px);
    }
    .dropchip span{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 58ch;
    }

    /* toggle button for drops */
    .dropsToggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(124,92,255,.35);
      background: rgba(124,92,255,.10);
      color: rgba(233,238,247,.95);
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .15px;
      cursor: pointer;
      user-select: none;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      white-space: nowrap;
    }
    .dropsToggle:hover{
      transform: translateY(-1px);
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.14);
    }
    .dropsToggle::before{
      content:"üëÅ";
      font-size: 12px;
      transform: translateY(-0.5px);
      opacity:.9;
    }

    .note {
      margin-top: 12px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }

    footer.footer {
      padding: 10px 16px 18px;
      color: rgba(168,179,199,.75);
    }

    /* ================================
       WIKI BUTTON
       ================================ */
    .nameRow{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    .nameRow .name{
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .wiki {
      margin-left: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(43, 228, 198, 0.38);
      background: rgba(43, 228, 198, 0.12);
      color: rgba(233,238,247,.95);
      text-decoration: none;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      white-space: nowrap;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .wiki:hover{
      transform: translateY(-1px);
      border-color: rgba(43, 228, 198, 0.58);
      background: rgba(43, 228, 198, 0.16);
    }
    .wiki::before{
      content:"‚Üó";
      opacity:.9;
      transform: translateY(-0.5px);
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">R</div>
    <div class="brand-text">
      <h1>Relic√°rio DeusOt</h1>
      <p id="brandSubtitle">Carregando‚Ä¶</p>
    </div>
  </div>

  <div class="tools">
    <input id="search" type="search" placeholder="Buscar item (ex: Tower Shield)..." />
    <button id="clear" type="button">Limpar</button>
  </div>
</header>

<main class="layout">
  <!-- Card separado no topo: CUSTOS -->
  <section class="panel">
    <div class="costs">
      <h2>Custos de upgrades (calculado do JSON)</h2>
      <p>
        Regras: cada n√≠vel pede <b>5 itens</b>, e cada item pede <b>25 unidades</b>.
        Os valores abaixo s√£o calculados usando <b>sites</b> da <b>comunidade</b>.
        Se um item estiver com <b>pre√ßo v</b>, ele √© considerado como <b>0</b> no c√°lculo.
      </p>
      <div class="chips" id="costChips"></div>
    </div>
  </section>

  <!-- Abaixo: grid com dois cards lado a lado -->
  <section class="row-grid">
    <!-- ESQUERDA: n√≠veis -->
    <section class="panel">
      <div class="levels-wrap">
        <h3>N√≠veis</h3>
        <div id="levelsGrid" class="grid-levels"></div>
      </div>
    </section>

    <!-- DIREITA: n√≠vel selecionado + itens -->
    <section class="panel">
      <div class="details-header">
        <h3 id="detailsTitle">Clique em um n√≠vel</h3>
        <span id="detailsMeta" class="meta"></span>
      </div>
      <div id="detailsBody" class="details-body">
        <div class="hint">
          Clique em um card para ver os itens do n√≠vel. Se voc√™ usar a busca, os cards dos n√≠veis
          que cont√™m o item v√£o mostrar um marcador <b>‚Äúaqui‚Äù</b> dentro deles.
        </div>
      </div>
    </section>
  </section>
</main>

<footer class="footer">
  <small>Single-file pronto para deploy no GitHub Pages (lembre de manter o <b>itens.json</b> ao lado do <b>index.html</b>).</small>
</footer>

<script>
  // ============================================================
  // CONFIG
  // ============================================================
  const JSON_URL = "./itens.json";

  // ============================================================
  // STATE (alimentado pelo JSON)
  // ============================================================
  let LEVELS = [];
  let LEVELS_FULL = []; // mant√©m o formato original (com prices)
  let QTY_PER_ITEM = 25;
  let COSTS = { acumulados: [], intervalos: [] };

  // para lembrar quais itens t√™m "droppedBy" expandido (por n√≠vel)
  const dropsExpanded = new Set(); // key: `${level}:${wikiSlug||name}`

  // ============================================================
  // DOM
  // ============================================================
  const els = {
    grid: document.querySelector("#levelsGrid"),
    title: document.querySelector("#detailsTitle"),
    meta: document.querySelector("#detailsMeta"),
    body: document.querySelector("#detailsBody"),
    search: document.querySelector("#search"),
    clear: document.querySelector("#clear"),
    costChips: document.querySelector("#costChips"),
    brandSubtitle: document.querySelector("#brandSubtitle"),
  };

  let activeLevel = 1;
  let activeSearch = "";

  // ============================================================
  // UTILS
  // ============================================================
  function normalize(s) { return String(s ?? "").toLowerCase().trim(); }

  function money(n) {
    const s = Math.round(Number(n || 0)).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getDisplayName(item) {
    if (item?.aliases?.length) return item.aliases[0];
    return item?.name ?? "";
  }

  function getItemPrice(item) {
    const p = item?.npcBuy?.price;
    if (p === null || p === undefined) return null;
    const num = Number(p);
    return Number.isFinite(num) ? num : null;
  }

  // pega o link da wiki conforme seu JSON
  function getWikiUrl(item) {
    if (item?.wikiUrl) return String(item.wikiUrl);
    if (item?.wikiSlug) {
      return `https://www.tibiawiki.com.br/wiki/${encodeURIComponent(String(item.wikiSlug))}`;
    }
    return null;
  }

  function getDropKey(levelNumber, item) {
    return `${levelNumber}:${String(item?.wikiSlug || item?.name || item?._displayName || "item")}`;
  }

  // ============================================================
  // BUILD DATA FROM JSON
  // ============================================================
  function buildFromJson(json) {
    QTY_PER_ITEM = Number(json?.meta?.qtyPerItem ?? 25);

    LEVELS_FULL = (json?.levels || []).map(l => ({
      level: l.level,
      items: (l.items || []).map(it => ({
        ...it,
        _displayName: getDisplayName(it),
        _price: getItemPrice(it),
        _qty: Number(it?.qty ?? QTY_PER_ITEM),
        _wikiUrl: getWikiUrl(it),
        _droppedBy: Array.isArray(it?.droppedBy) ? it.droppedBy.filter(Boolean) : []
      }))
    }));

    LEVELS = LEVELS_FULL.map(l => ({
      level: l.level,
      items: l.items.map(it => it._displayName),
    }));

    const totalLevels = LEVELS.length;
    const first = LEVELS[0]?.level ?? 1;

    els.brandSubtitle.textContent =
      `${totalLevels} n√≠veis ‚Ä¢ 5 itens por n√≠vel ‚Ä¢ ${QTY_PER_ITEM} unidades por item`;

    activeLevel = first;
  }

  // ============================================================
  // COSTS (calculado do JSON)
  // ============================================================
  function calcCostsFromJson() {
    const perLevel = LEVELS_FULL.map(lvl => {
      const total = (lvl.items || []).reduce((acc, it) => {
        const price = it._price ?? 0;
        const qty = it._qty ?? QTY_PER_ITEM;
        return acc + (price * qty);
      }, 0);
      return { level: lvl.level, total };
    });

    if (!perLevel.length) return { acumulados: [], intervalos: [] };

    const maxLevel = Math.max(...perLevel.map(x => x.level));
    const sumRange = (a, b) => perLevel
      .filter(x => x.level >= a && x.level <= b)
      .reduce((acc, x) => acc + x.total, 0);

    const acumulados = [
      { label: `1 ‚Üí 5 (acumulado)`,  value: sumRange(1, Math.min(5, maxLevel)) },
      { label: `1 ‚Üí 10 (acumulado)`, value: sumRange(1, Math.min(10, maxLevel)) },
      { label: `1 ‚Üí 15 (acumulado)`, value: sumRange(1, Math.min(15, maxLevel)) },
      { label: `1 ‚Üí 20 (acumulado)`, value: sumRange(1, Math.min(20, maxLevel)) },
      { label: `1 ‚Üí ${maxLevel} (acumulado)`, value: sumRange(1, maxLevel) },
    ].filter(c => c.value > 0);

    const intervalos = [
      { label: `5 ‚Üí 10 (intervalo)`, value: sumRange(6, Math.min(10, maxLevel)) },
      { label: `10 ‚Üí 15 (intervalo)`, value: sumRange(11, Math.min(15, maxLevel)) },
      { label: `15 ‚Üí 20 (intervalo)`, value: sumRange(16, Math.min(20, maxLevel)) },
      { label: `20 ‚Üí ${maxLevel} (intervalo)`, value: sumRange(21, maxLevel) },
    ].filter(c => c.value > 0);

    return { acumulados, intervalos };
  }

  // ============================================================
  // RENDER
  // ============================================================
  function renderCosts() {
    const parts = [];

    COSTS.acumulados.forEach(c => {
      parts.push(`
        <div class="chip">
          <span class="tag">acumulado</span>
          <b>${escapeHtml(c.label)}</b>
          <span>‚Äî ${money(c.value)}</span>
        </div>
      `);
    });

    COSTS.intervalos.forEach(c => {
      parts.push(`
        <div class="chip">
          <span class="tag">intervalo</span>
          <b>${escapeHtml(c.label)}</b>
          <span>‚Äî ${money(c.value)}</span>
        </div>
      `);
    });

    els.costChips.innerHTML = parts.join("") || `
      <div class="chip">
        <span class="tag">info</span>
        <b>Sem custos</b>
        <span>‚Äî (verifique se npcBuy.price est√° preenchido no JSON)</span>
      </div>
    `;
  }

  function levelHasMatch(levelObj, q) {
    if (!q) return false;
    const nq = normalize(q);
    return levelObj.items.some(it => normalize(it).includes(nq));
  }

  function countMatches(levelObj, q) {
    if (!q) return 0;
    const nq = normalize(q);
    return levelObj.items.filter(it => normalize(it).includes(nq)).length;
  }

  function renderCards() {
    els.grid.innerHTML = "";

    LEVELS.forEach((lvl) => {
      const has = levelHasMatch(lvl, activeSearch);
      const hits = countMatches(lvl, activeSearch);

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.level = String(lvl.level);

      if (activeLevel === lvl.level) card.classList.add("active");

      card.innerHTML = `
        <div class="lvl">N√≠vel ${lvl.level}</div>
        <div class="sub">${lvl.items.length} itens ‚Ä¢ ${QTY_PER_ITEM} un. cada</div>
        ${activeSearch ? `<div class="badge">${hits ? `${hits} match` : "0 match"}</div>` : ""}
        ${has ? `<div class="here">aqui</div>` : ""}
      `;

      if (activeSearch && has) {
        card.style.borderColor = "rgba(43, 228, 198, 0.35)";
      }

      card.addEventListener("click", () => {
        activeLevel = lvl.level;
        highlightActive();
        renderDetails(activeLevel);
      });

      els.grid.appendChild(card);
    });
  }

  function highlightActive() {
    document.querySelectorAll(".card").forEach((c) => c.classList.remove("active"));
    const el = document.querySelector(`.card[data-level="${activeLevel}"]`);
    if (el) el.classList.add("active");
  }

  function renderDetails(levelNumber) {
    const lvlSimple = LEVELS.find(x => x.level === levelNumber);
    const lvlFull = LEVELS_FULL.find(x => x.level === levelNumber);
    if (!lvlSimple || !lvlFull) return;

    const filteredFull = activeSearch
      ? lvlFull.items.filter(it => normalize(it._displayName).includes(normalize(activeSearch)))
      : lvlFull.items;

    els.title.textContent = `N√≠vel ${lvlSimple.level}`;
    els.meta.textContent = activeSearch
      ? `Mostrando ${filteredFull.length} de ${lvlFull.items.length} itens (filtro ativo)`
      : `${lvlFull.items.length} itens`;

    const sumLevel = filteredFull.reduce((acc, it) => {
      const price = it._price ?? 0;
      const qty = it._qty ?? QTY_PER_ITEM;
      return acc + (price * qty);
    }, 0);

    els.body.innerHTML = `
      <div class="items">
        ${filteredFull.map(it => {
          const name = it._displayName;
          const qty = it._qty ?? QTY_PER_ITEM;
          const price = it._price; // pode ser null
          const total = (price ?? 0) * qty;

          const priceText = (price === null)
            ? `<b>pre√ßo:</b> <span style="opacity:.8">n√£o definido</span>`
            : `<b>pre√ßo:</b> ${money(price)} gp`;

          const totalText = (price === null)
            ? `<b>total:</b> <span style="opacity:.8">‚Äî</span>`
            : `<b>total:</b> ${money(total)} gp`;

          const wikiBtn = it._wikiUrl
            ? `<a class="wiki" href="${escapeHtml(it._wikiUrl)}" target="_blank" rel="noopener noreferrer">Wiki</a>`
            : "";

          // =========================
          // ‚úÖ DROPPED BY (NOVO)
          // =========================
          const drops = Array.isArray(it._droppedBy) ? it._droppedBy : [];
          const hasDrops = drops.length > 0;

          const key = getDropKey(levelNumber, it);
          const expanded = dropsExpanded.has(key);

          const dropsBlock = (() => {
            if (!hasDrops) {
              return `
                <div class="drops">
                  <div class="drops-head">
                    <div><b>Dropa de:</b> <span style="color: rgba(168,179,199,.92);">n√£o informado</span></div>
                    <div class="count">0</div>
                  </div>
                </div>
              `;
            }

            // mostra poucos e deixa expandir (pra n√£o virar um text√£o gigantesco)
            const previewCount = 10;
            const list = expanded ? drops : drops.slice(0, previewCount);
            const hidden = Math.max(0, drops.length - list.length);

            const toggle = (drops.length > previewCount)
              ? `<button class="dropsToggle" type="button" data-action="toggleDrops" data-key="${escapeHtml(key)}">
                   ${expanded ? "Recolher" : "Ver tudo"}${hidden && !expanded ? ` (+${hidden})` : ""}
                 </button>`
              : "";

            return `
              <div class="drops">
                <div class="drops-head">
                  <div><b>Dropa de:</b></div>
                  <div style="display:flex; align-items:center; gap:10px;">
                    ${toggle}
                    <div class="count">${drops.length}</div>
                  </div>
                </div>

                <div class="chipsWrap">
                  ${list.map(m => `
                    <span class="dropchip" title="${escapeHtml(m)}"><span>${escapeHtml(m)}</span></span>
                  `).join("")}
                </div>
              </div>
            `;
          })();

          return `
            <div class="item">
              <div class="nameRow">
                <div class="name">${escapeHtml(name)}</div>
                ${wikiBtn}
              </div>
              <div class="qty">${qty} un.</div>

              <div class="subline">${priceText} ‚Ä¢ ${totalText}</div>

              ${dropsBlock}
            </div>
          `;
        }).join("")}
      </div>

      <div class="note">
        ${activeSearch
          ? `Filtro atual: <b>${escapeHtml(activeSearch)}</b>. Cards com o item exibem o marcador <b>‚Äúaqui‚Äù</b>.`
          : `Use a busca para localizar rapidamente em quais n√≠veis um item aparece.`}
        <br/>
        <span style="opacity:.9">Total deste n√≠vel (considerando itens listados acima): <b>${money(sumLevel)} gp</b>.</span>
      </div>
    `;

    // event delegation: toggle drops
    els.body.querySelectorAll('[data-action="toggleDrops"]').forEach(btn => {
      btn.addEventListener("click", (e) => {
        const k = e.currentTarget.getAttribute("data-key");
        if (!k) return;
        if (dropsExpanded.has(k)) dropsExpanded.delete(k);
        else dropsExpanded.add(k);

        // re-render s√≥ o painel de detalhes (mant√©m seu fluxo)
        renderDetails(levelNumber);
      });
    });
  }

  // ============================================================
  // LOAD JSON + INIT
  // ============================================================
  async function init() {
    try {
      const res = await fetch(JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Falha ao carregar JSON (${res.status})`);
      const json = await res.json();

      buildFromJson(json);
      COSTS = calcCostsFromJson();

      renderCosts();
      renderCards();
      highlightActive();
      renderDetails(activeLevel);

      els.search.addEventListener("input", (e) => {
        activeSearch = e.target.value || "";
        renderCards();
        renderDetails(activeLevel);
      });

      els.clear.addEventListener("click", () => {
        activeSearch = "";
        els.search.value = "";
        renderCards();
        renderDetails(activeLevel);
      });

    } catch (err) {
      console.error(err);

      els.brandSubtitle.textContent = "Erro ao carregar itens.json";
      els.grid.innerHTML = "";
      els.costChips.innerHTML = `
        <div class="chip">
          <span class="tag">erro</span>
          <b>JSON n√£o carregou</b>
          <span>‚Äî verifique servidor local e caminho</span>
        </div>
      `;
      els.title.textContent = "Erro ao carregar itens.json";
      els.meta.textContent = "";
      els.body.innerHTML = `
        <div class="hint">
          N√£o consegui carregar <b>${escapeHtml(JSON_URL)}</b>.<br/><br/>
          <b>Checklist r√°pido:</b><br/>
          ‚Ä¢ Coloque <b>itens.json</b> na mesma pasta do <b>index.html</b><br/>
          ‚Ä¢ Rode por servidor local (ex: <b>npx live-server</b>) ‚Äî n√£o abre com duplo clique<br/>
          ‚Ä¢ Abra pelo endere√ßo do servidor (ex: http://127.0.0.1:8080)<br/>
        </div>
      `;
    }
  }

  init();
</script>
</body>
</html>
